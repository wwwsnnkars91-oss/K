<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K - Kitap AlÄ±ntÄ±larÄ±</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FDFCF8;
            padding: 20px;
            padding-bottom: 80px;
        }
        h1 { font-size: 28px; margin-bottom: 20px; color: #333; }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background: #4E9F3D;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .btn:active { background: #3d7e30; }
        .book-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .book-cover {
            width: 60px;
            height: 85px;
            object-fit: cover;
            border-radius: 5px;
            background: #ddd;
        }
        .book-info { flex: 1; }
        .book-title { font-weight: 600; font-size: 18px; }
        .book-author { color: #666; font-size: 14px; }
        .quote-count { color: #999; font-size: 13px; margin-top: 5px; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        textarea { min-height: 120px; resize: vertical; }
        .stars { font-size: 28px; user-select: none; }
        .star { cursor: pointer; color: #ddd; }
        .star.active { color: #FFD700; }
        #camera-preview {
            width: 100%;
            max-height: 400px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .quote-item {
            background: #f9f9f9;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #4E9F3D;
            border-radius: 5px;
        }
        .loading {
            display: none;
            text-align: center;
            color: #4E9F3D;
            margin: 20px 0;
        }
        .book-detail-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .book-detail-cover {
            width: 120px;
            height: 170px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</head>
<body>

<div id="app">
    <h1>ğŸ“š K - KitaplarÄ±m</h1>
    <div id="book-list"></div>
</div>

<div class="bottom-bar">
    <button class="btn" onclick="openAddBookModal()">â• Yeni Kitap</button>
    <button class="btn" onclick="openQuickQuoteModal()">ğŸ“¸ HÄ±zlÄ± AlÄ±ntÄ±</button>
</div>

<!-- Yeni Kitap Modal -->
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <h2>ğŸ“– Yeni Kitap Ekle</h2>
        <input type="text" id="bookTitle" placeholder="Kitap AdÄ±">
        <input type="text" id="bookAuthor" placeholder="Yazar">
        <input type="number" id="bookPages" placeholder="Sayfa SayÄ±sÄ±">
        <input type="month" id="bookDate" placeholder="Okuma ZamanÄ±">
        <div class="stars" id="ratingStars">
            <span class="star" onclick="setRating(1)">â˜…</span>
            <span class="star" onclick="setRating(2)">â˜…</span>
            <span class="star" onclick="setRating(3)">â˜…</span>
            <span class="star" onclick="setRating(4)">â˜…</span>
            <span class="star" onclick="setRating(5)">â˜…</span>
        </div>
        <input type="file" accept="image/*" id="bookCover" onchange="previewCover(event)">
        <img id="coverPreview" style="max-width: 100px; margin: 10px 0; display: none;">
        <button class="btn" onclick="saveBook()">ğŸ’¾ Kaydet</button>
        <button class="btn" onclick="closeModal('addBookModal')" style="background: #999;">Ä°ptal</button>
    </div>
</div>

<!-- Kitap Detay Modal -->
<div id="bookDetailModal" class="modal">
    <div class="modal-content">
        <button class="btn" onclick="closeModal('bookDetailModal')" style="float: right; background: #999;">âœ•</button>
        <div id="bookDetailContent"></div>
    </div>
</div>

<!-- AlÄ±ntÄ± Ekle Modal -->
<div id="addQuoteModal" class="modal">
    <div class="modal-content">
        <h2>ğŸ“¸ AlÄ±ntÄ± Ekle</h2>
        <input type="file" accept="image/*" capture="environment" id="quotePhoto" onchange="processOCR(event)">
        <img id="camera-preview" style="display: none;">
        <div class="loading" id="loading">ğŸ”„ Metin tanÄ±nÄ±yor...</div>
        <textarea id="quoteText" placeholder="AlÄ±ntÄ± metni"></textarea>
        <textarea id="quoteNote" placeholder="Not (isteÄŸe baÄŸlÄ±)"></textarea>
        <button class="btn" onclick="saveQuote()">ğŸ’¾ Kaydet ve JPEG OluÅŸtur</button>
        <button class="btn" onclick="closeModal('addQuoteModal')" style="background: #999;">Ä°ptal</button>
    </div>
</div>

<script>
let books = JSON.parse(localStorage.getItem('books')) || [];
let currentBookId = null;
let currentRating = 0;

function renderBooks() {
    const list = document.getElementById('book-list');
    list.innerHTML = books.map(book => `
        <div class="book-item" onclick="openBookDetail('${book.id}')">
            <img class="book-cover" src="${book.cover || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'85\'%3E%3Crect fill=\'%23ddd\' width=\'60\' height=\'85\'/%3E%3C/svg%3E'}" alt="Kapak">
            <div class="book-info">
                <div class="book-title">${book.title}</div>
                <div class="book-author">${book.author}</div>
                <div class="quote-count">${book.quotes.length} alÄ±ntÄ±</div>
            </div>
        </div>
    `).join('');
}

function openAddBookModal() {
    document.getElementById('addBookModal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function setRating(rating) {
    currentRating = rating;
    document.querySelectorAll('.star').forEach((star, i) => {
        star.classList.toggle('active', i < rating);
    });
}

function previewCover(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const preview = document.getElementById('coverPreview');
            preview.src = ev.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function saveBook() {
    const title = document.getElementById('bookTitle').value;
    const author = document.getElementById('bookAuthor').value;
    const pages = document.getElementById('bookPages').value;
    const date = document.getElementById('bookDate').value;
    const coverFile = document.getElementById('bookCover').files[0];

    if (!title || !author) {
        alert('LÃ¼tfen en az kitap adÄ± ve yazar girin');
        return;
    }

    const book = {
        id: Date.now().toString(),
        title, author, pages, date,
        rating: currentRating,
        cover: document.getElementById('coverPreview').src || '',
        quotes: []
    };

    books.push(book);
    localStorage.setItem('books', JSON.stringify(books));
    renderBooks();
    closeModal('addBookModal');
    
    // Reset form
    document.getElementById('bookTitle').value = '';
    document.getElementById('bookAuthor').value = '';
    document.getElementById('bookPages').value = '';
    document.getElementById('bookDate').value = '';
    document.getElementById('coverPreview').style.display = 'none';
    currentRating = 0;
    document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
}

function openBookDetail(bookId) {
    const book = books.find(b => b.id === bookId);
    if (!book) return;
    
    currentBookId = bookId;
    const stars = 'â˜…'.repeat(book.rating) + 'â˜†'.repeat(5 - book.rating);
    
    document.getElementById('bookDetailContent').innerHTML = `
        <div class="book-detail-header">
            <img class="book-detail-cover" src="${book.cover || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'170\'%3E%3Crect fill=\'%23ddd\' width=\'120\' height=\'170\'/%3E%3C/svg%3E'}" alt="Kapak">
            <h2>${book.title}</h2>
            <p style="color: #666;">${book.author}</p>
            <p style="color: #999; font-size: 14px;">${book.pages ? book.pages + ' sayfa' : ''} ${book.date ? 'â€¢ ' + book.date : ''}</p>
            <div style="color: #FFD700; font-size: 20px; margin: 10px 0;">${stars}</div>
        </div>
        <button class="btn" onclick="openAddQuoteModal('${bookId}')">ğŸ“¸ AlÄ±ntÄ± Ekle</button>
        <h3 style="margin: 20px 0 10px;">AlÄ±ntÄ±lar:</h3>
        ${book.quotes.length === 0 ? '<p style="color: #999;">HenÃ¼z alÄ±ntÄ± eklenmemiÅŸ</p>' : 
            book.quotes.map((q, i) => `
                <div class="quote-item">
                    <p>"${q.text}"</p>
                    ${q.note ? `<p style="color: #666; font-size: 13px; margin-top: 8px;">ğŸ’­ ${q.note}</p>` : ''}
                    ${q.jpeg ? `<button class="btn" onclick="downloadJpeg('${bookId}', ${i})" style="margin-top: 10px;">â¬‡ï¸ JPEG Ä°ndir</button>` : ''}
                </div>
            `).join('')
        }
    `;
    
    document.getElementById('bookDetailModal').classList.add('active');
}

function openQuickQuoteModal() {
    if (books.length === 0) {
        alert('Ã–nce bir kitap eklemelisiniz');
        return;
    }
    currentBookId = books[0].id; // Ä°lk kitaba ekle veya seÃ§im yaptÄ±r
    openAddQuoteModal(currentBookId);
}

function openAddQuoteModal(bookId) {
    currentBookId = bookId;
    document.getElementById('addQuoteModal').classList.add('active');
    document.getElementById('quoteText').value = '';
    document.getElementById('quoteNote').value = '';
}

function processOCR(e) {
    const file = e.target.files[0];
    if (!file) return;

    const preview = document.getElementById('camera-preview');
    const reader = new FileReader();
    
    reader.onload = (ev) => {
        preview.src = ev.target.result;
        preview.style.display = 'block';
        
        document.getElementById('loading').style.display = 'block';
        
        Tesseract.recognize(
            ev.target.result,
            'tur',
            { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
            document.getElementById('quoteText').value = text;
            document.getElementById('loading').style.display = 'none';
        });
    };
    
    reader.readAsDataURL(file);
}

function saveQuote() {
    const text = document.getElementById('quoteText').value;
    const note = document.getElementById('quoteNote').value;
    
    if (!text) {
        alert('LÃ¼tfen alÄ±ntÄ± metnini girin');
        return;
    }
    
    // JPEG oluÅŸtur
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 1920;
    const ctx = canvas.getContext('2d');
    
    // Arka plan
    ctx.fillStyle = '#FDFCF8';
    ctx.fillRect(0, 0, 1080, 1920);
    
    // Metin
    ctx.fillStyle = '#333';
    ctx.font = '42px serif';
    ctx.textAlign = 'center';
    
    const maxWidth = 900;
    const lineHeight = 60;
    const words = text.split(' ');
    let line = '';
    let y = 400;
    
    words.forEach(word => {
        const testLine = line + word + ' ';
        if (ctx.measureText(testLine).width > maxWidth) {
            ctx.fillText(line, 540, y);
            line = word + ' ';
            y += lineHeight;
        } else {
            line = testLine;
        }
    });
    ctx.fillText(line, 540, y);
    
    // Kitap bilgisi
    const book = books.find(b => b.id === currentBookId);
    ctx.font = '32px sans-serif';
    ctx.fillStyle = '#999';
    ctx.fillText(`â€” ${book.title}`, 540, 1600);
    ctx.fillText(book.author, 540, 1660);
    
    const jpeg = canvas.toDataURL('image/jpeg');
    
    // AlÄ±ntÄ±yÄ± kaydet
    const quote = { text, note, jpeg, date: new Date().toISOString() };
    const bookIndex = books.findIndex(b => b.id === currentBookId);
    books[bookIndex].quotes.push(quote);
    localStorage.setItem('books', JSON.stringify(books));
    
    closeModal('addQuoteModal');
    openBookDetail(currentBookId);
}

function downloadJpeg(bookId, quoteIndex) {
    const book = books.find(b => b.id === bookId);
    const quote = book.quotes[quoteIndex];
    
    const a = document.createElement('a');
    a.href = quote.jpeg;
    a.download = `${book.title}_alinti_${quoteIndex + 1}.jpg`;
    a.click();
}

// Ä°lk yÃ¼kleme
renderBooks();
</script>

</body>
</html>
